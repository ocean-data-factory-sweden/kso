name: part2
on:
  push:
    branches:
      - master
      - dev
    paths-ignore:
      - Dockerfile
      - kso_utils/requirements
      - yolov5_tracker/requirements
      - yolov5/requirements
  pull_request: 
    branches:
      - master
      - dev
    paths-ignore:
      - Dockerfile
      - kso_utils/requirements
      - yolov5_tracker/requirements
      - yolov5/requirements
  workflow_run:
    workflows: [part1]
    types: [completed]
jobs:
  part2:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      -
        name: on workflow_run
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        run: echo 'triggering by workflow_run'
      - 
        name: on PR or push
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        run: echo 'triggering by PR or push'
      - name: Show GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: print sha
        run: echo ${{ github.sha }} 
      - name: Check docker exists Pablo get list
        run: |
          GHCR_TOKEN=$(echo ${{ secrets.GITHUB_TOKEN }} | base64)
          curl -H "Authorization: Bearer ${GHCR_TOKEN}" https://ghcr.io/v2/ocean-data-factory-sweden/kso/tags/list
      - name: tag-exists
        id: tag-exists
        run: |
          GHCR_TOKEN=$(echo ${{ secrets.GITHUB_TOKEN }} | base64)
          curl --head --fail -H "Authorization: Bearer ${GHCR_TOKEN}" https://ghcr.io/v2/ocean-data-factory-sweden/kso/manifests/test6
          continue-on-error: true
      - name: if check tag was successfull
        if: steps.tag-exists.outcome == 'success'
        run: echo 'the tag exists'
      - name: if check tag failed
        if: steps.tag-exists.outcome == 'failure'
        run: echo 'the tag does not exist'
        